<h2 class="component">All Users</h2>

<div class="table-wrapper">
  <p-table
    [value]="users()"
    [loading]="loading()"
    [paginator]="true"
    [rows]="environment.defaultPageSize"
    [totalRecords]="totalRecords()"
    [lazy]="true"
    (onLazyLoad)="onPageChange($event)"
  >
    <ng-template pTemplate="header">
      <tr>
        <th scope="col"></th>
        <th scope="col" aria-label="ID">ID</th>
        <th scope="col" aria-label="Username">Username</th>
        <th scope="col" aria-label="Email">Email</th>
        <th scope="col" aria-label="Name">Name</th>
        <th scope="col" aria-label="Registered">Registered</th>
        <th scope="col" aria-label="Active">Active</th>
        <th scope="col" aria-label="Location">Location</th>
        <th scope="col" aria-label="Roles">Roles</th>
        <th scope="col" aria-label="Edit"></th>
        <th scope="col" aria-label="Delete"></th>
      </tr>
    </ng-template>

    <ng-template pTemplate="body" let-user>
      <tr>
        <td>
          <a [routerLink]="getUserRouterLink(user.username)">
            <img
              [src]="UrlUtilService.getMediaUrl(user.pictureURI || environment.userDummyProfilePicRelativeUrl)"
              [alt]="user.username + '\'s avatar'"
              class="user-avatar"
            />
          </a>
        </td>

        <td><small>{{ user.id }}</small></td>
        <td>{{ user.username }}</td>
        <td>{{ user.email }}</td>
        <td>{{ user.firstName }} {{ user.surname }}</td>
        <td>{{ user.registerDate | date:'yyyy-MM-dd' }}</td>

        <td>
          <p-tag
            [value]="user.isActive ? 'Active' : 'Inactive'"
            [severity]="user.isActive ? 'success' : 'danger'"
          />
        </td>

        <td>{{ user.location }}</td>

        <td>
          <div class="flex flex-col gap-1">
            <p-multiselect
              [options]="allRoles()"
              optionLabel="name"
              placeholder="View/Edit Roles"
              [fluid]="true"
              [ngModel]="getUserRoles(user)"
              (ngModelChange)="onRolesChange($event, user)"
              dataKey="id"
              [filter]="true"
              [showToggleAll]="false"
              [maxSelectedLabels]="0"
              [selectedItemsLabel]="'View/Edit Roles'">
            ></p-multiselect>
          </div>
        </td>

        <td>
          <i class="pi pi-user-edit clickable" title="Edit" (click)="onEdit(user)" aria-label="Edit user"></i>
        </td>
        <td>
          <i class="pi pi-trash clickable" title="Delete" (click)="onDelete(user)" aria-label="Delete user"></i>
        </td>
      </tr>
    </ng-template>
  </p-table>

  @if (loading()) {
    <div class="loader-overlay">
      <div class="loader-content">
        <i class="pi pi-spin pi-spinner"></i>
        <p>Loading users...</p>
      </div>
    </div>
  }
</div>
